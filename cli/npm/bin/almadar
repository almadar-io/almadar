#!/usr/bin/env node

const { execFileSync } = require('child_process');
const path = require('path');
const fs = require('fs');

const BINARY_NAME = process.platform === 'win32' ? 'almadar.exe' : 'almadar';

function getBinaryPath() {
  const platform = process.platform;
  const arch = process.arch;

  // Map Node.js platform/arch to package names
  const platformMap = {
    'darwin-x64': '@almadar/cli-darwin-x64',
    'darwin-arm64': '@almadar/cli-darwin-arm64',
    'linux-x64': '@almadar/cli-linux-x64',
    'linux-arm64': '@almadar/cli-linux-arm64',
    'win32-x64': '@almadar/cli-win32-x64',
  };

  const key = `${platform}-${arch}`;
  const packageName = platformMap[key];

  if (!packageName) {
    console.error(`Unsupported platform: ${platform}-${arch}`);
    console.error('Supported platforms: darwin-x64, darwin-arm64, linux-x64, linux-arm64, win32-x64');
    process.exit(1);
  }

  // Try to find the binary in node_modules
  const possiblePaths = [
    // Installed as dependency
    path.join(__dirname, '..', 'node_modules', packageName, BINARY_NAME),
    // Hoisted to parent node_modules
    path.join(__dirname, '..', '..', packageName, BINARY_NAME),
    // Global install
    path.join(__dirname, '..', '..', '..', packageName, BINARY_NAME),
  ];

  for (const binaryPath of possiblePaths) {
    if (fs.existsSync(binaryPath)) {
      return binaryPath;
    }
  }

  console.error(`Could not find Almadar binary for ${platform}-${arch}`);
  console.error('Please try reinstalling: npm install -g @almadar/cli');
  process.exit(1);
}

const binaryPath = getBinaryPath();

try {
  execFileSync(binaryPath, process.argv.slice(2), {
    stdio: 'inherit',
    env: process.env,
  });
} catch (error) {
  if (error.status !== undefined) {
    process.exit(error.status);
  }
  throw error;
}
