{
  "name": "cross-orbital-test",
  "version": "1.0.0",
  "description": "Test: Cross-orbital communication via emit/listen",
  "orbitals": [
    {
      "name": "CartManager",
      "entity": {
        "name": "Cart",
        "persistence": "runtime",
        "runtime": true,
        "fields": [
          { "name": "id", "type": "string", "required": true },
          { "name": "itemCount", "type": "number", "default": 0 },
          { "name": "total", "type": "number", "default": 0 }
        ]
      },
      "traits": [
        { "ref": "CartActions", "linkedEntity": "Cart" }
      ],
      "pages": [],
      "emits": ["ITEM_ADDED", "CART_CLEARED"],
      "listens": []
    },
    {
      "name": "NotificationManager",
      "entity": {
        "name": "Notification",
        "persistence": "runtime",
        "runtime": true,
        "fields": [
          { "name": "id", "type": "string", "required": true },
          { "name": "message", "type": "string" },
          { "name": "count", "type": "number", "default": 0 }
        ]
      },
      "traits": [
        { "ref": "NotificationHandler", "linkedEntity": "Notification" }
      ],
      "pages": [],
      "emits": [],
      "listens": [
        { "event": "ITEM_ADDED", "from": "CartManager" },
        { "event": "CART_CLEARED", "from": "CartManager" }
      ]
    }
  ],
  "traits": [
    {
      "name": "CartActions",
      "category": "interaction",
      "stateMachine": {
        "states": [
          { "name": "empty", "initial": true },
          { "name": "hasItems" }
        ],
        "events": [
          { "name": "ADD_ITEM", "label": "Add Item", "payload": [
            { "name": "price", "type": "number", "required": true }
          ]},
          { "name": "CLEAR", "label": "Clear Cart" }
        ],
        "transitions": [
          {
            "from": "empty",
            "event": "ADD_ITEM",
            "to": "hasItems",
            "effects": [
              ["increment", "itemCount", 1],
              ["set", "total", ["+", "@entity.total", "@payload.price"]],
              ["emit", "ITEM_ADDED", { "itemCount": "@entity.itemCount", "total": "@entity.total" }]
            ]
          },
          {
            "from": "hasItems",
            "event": "ADD_ITEM",
            "to": "hasItems",
            "effects": [
              ["increment", "itemCount", 1],
              ["set", "total", ["+", "@entity.total", "@payload.price"]],
              ["emit", "ITEM_ADDED", { "itemCount": "@entity.itemCount", "total": "@entity.total" }]
            ]
          },
          {
            "from": "hasItems",
            "event": "CLEAR",
            "to": "empty",
            "effects": [
              ["set", "itemCount", 0],
              ["set", "total", 0],
              ["emit", "CART_CLEARED", {}]
            ]
          }
        ]
      }
    },
    {
      "name": "NotificationHandler",
      "category": "interaction",
      "stateMachine": {
        "states": [
          { "name": "idle", "initial": true },
          { "name": "notified" }
        ],
        "events": [
          { "name": "ITEM_ADDED", "label": "Item Added" },
          { "name": "CART_CLEARED", "label": "Cart Cleared" }
        ],
        "transitions": [
          {
            "from": "idle",
            "event": "ITEM_ADDED",
            "to": "notified",
            "effects": [
              ["increment", "count", 1],
              ["set", "message", "Item added to cart"]
            ]
          },
          {
            "from": "notified",
            "event": "ITEM_ADDED",
            "to": "notified",
            "effects": [
              ["increment", "count", 1]
            ]
          },
          {
            "from": "notified",
            "event": "CART_CLEARED",
            "to": "idle",
            "effects": [
              ["set", "message", "Cart cleared"],
              ["set", "count", 0]
            ]
          }
        ]
      },
      "listens": [
        { "event": "ITEM_ADDED", "scope": "external" },
        { "event": "CART_CLEARED", "scope": "external" }
      ]
    }
  ]
}
