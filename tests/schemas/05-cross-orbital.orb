{
  "name": "cross-orbital-test",
  "version": "1.0.0",
  "description": "Test: Cross-orbital communication via emit/listen",
  "orbitals": [
    {
      "name": "CartManager",
      "entity": {
        "name": "Cart",
        "persistence": "runtime",
        "fields": [
          { "name": "id", "type": "string", "required": true },
          { "name": "itemCount", "type": "number", "default": 0 },
          { "name": "total", "type": "number", "default": 0 }
        ]
      },
      "traits": [
        {
          "name": "CartActions",
          "linkedEntity": "Cart",
          "category": "interaction",
          "emits": [
            {
              "event": "ITEM_ADDED",
              "scope": "external",
              "description": "Emitted when an item is added to cart",
              "payload": [
                { "name": "itemCount", "type": "number", "required": true },
                { "name": "total", "type": "number", "required": true }
              ]
            },
            {
              "event": "CART_CLEARED",
              "scope": "external",
              "description": "Emitted when cart is cleared"
            }
          ],
          "stateMachine": {
            "states": [
              { "name": "empty", "isInitial": true },
              { "name": "hasItems" }
            ],
            "events": [
              { "key": "INIT", "name": "Initialize" },
              { "key": "ADD_ITEM", "name": "Add Item", "payload": [
                { "name": "price", "type": "number", "required": true }
              ]},
              { "key": "CLEAR", "name": "Clear Cart" }
            ],
            "transitions": [
              {
                "from": "empty",
                "event": "INIT",
                "to": "empty",
                "effects": [
                  ["render-ui", "main", {
                    "type": "stats",
                    "props": {
                      "title": "Shopping Cart",
                      "value": "@entity.itemCount",
                      "subtitle": "Total: $@entity.total",
                      "actions": [
                        { "event": "ADD_ITEM", "label": "Add Item" }
                      ]
                    }
                  }]
                ]
              },
              {
                "from": "empty",
                "event": "ADD_ITEM",
                "to": "hasItems",
                "effects": [
                  ["increment", "@entity.itemCount", 1],
                  ["set", "@entity.total", ["+", "@entity.total", "@payload.price"]],
                  ["emit", "ITEM_ADDED", { "itemCount": "@entity.itemCount", "total": "@entity.total" }]
                ]
              },
              {
                "from": "hasItems",
                "event": "ADD_ITEM",
                "to": "hasItems",
                "effects": [
                  ["increment", "@entity.itemCount", 1],
                  ["set", "@entity.total", ["+", "@entity.total", "@payload.price"]],
                  ["emit", "ITEM_ADDED", { "itemCount": "@entity.itemCount", "total": "@entity.total" }]
                ]
              },
              {
                "from": "hasItems",
                "event": "CLEAR",
                "to": "empty",
                "effects": [
                  ["set", "@entity.itemCount", 0],
                  ["set", "@entity.total", 0],
                  ["emit", "CART_CLEARED", {}]
                ]
              }
            ]
          }
        }
      ],
      "pages": [
        {
          "name": "CartPage",
          "path": "/cart",
          "traits": [
            { "ref": "CartActions", "linkedEntity": "Cart" }
          ]
        }
      ],
      "emits": ["ITEM_ADDED", "CART_CLEARED"]
    },
    {
      "name": "NotificationManager",
      "entity": {
        "name": "Notification",
        "persistence": "runtime",
        "fields": [
          { "name": "id", "type": "string", "required": true },
          { "name": "message", "type": "string" },
          { "name": "count", "type": "number", "default": 0 }
        ]
      },
      "traits": [
        {
          "name": "NotificationHandler",
          "linkedEntity": "Notification",
          "category": "interaction",
          "stateMachine": {
            "states": [
              { "name": "idle", "isInitial": true },
              { "name": "notified" }
            ],
            "events": [
              { "key": "INIT", "name": "Initialize" },
              { "key": "ITEM_ADDED", "name": "Item Added" },
              { "key": "CART_CLEARED", "name": "Cart Cleared" }
            ],
            "transitions": [
              {
                "from": "idle",
                "event": "INIT",
                "to": "idle",
                "effects": [
                  ["render-ui", "main", {
                    "type": "stats",
                    "props": {
                      "title": "Notifications",
                      "value": "@entity.count",
                      "subtitle": "@entity.message"
                    }
                  }]
                ]
              },
              {
                "from": "idle",
                "event": "ITEM_ADDED",
                "to": "notified",
                "effects": [
                  ["increment", "@entity.count", 1],
                  ["set", "@entity.message", "Item added to cart"]
                ]
              },
              {
                "from": "notified",
                "event": "ITEM_ADDED",
                "to": "notified",
                "effects": [
                  ["increment", "@entity.count", 1]
                ]
              },
              {
                "from": "notified",
                "event": "CART_CLEARED",
                "to": "idle",
                "effects": [
                  ["set", "@entity.message", "Cart cleared"],
                  ["set", "@entity.count", 0]
                ]
              }
            ]
          },
          "listens": [
            { "event": "ITEM_ADDED", "scope": "external" },
            { "event": "CART_CLEARED", "scope": "external" }
          ]
        }
      ],
      "pages": [
        {
          "name": "NotificationsPage",
          "path": "/notifications",
          "traits": [
            { "ref": "NotificationHandler", "linkedEntity": "Notification" }
          ]
        }
      ],
      "listens": [
        { "event": "ITEM_ADDED", "from": "CartManager" },
        { "event": "CART_CLEARED", "from": "CartManager" }
      ]
    }
  ]
}
