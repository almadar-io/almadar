{
  "name": "ticks-test",
  "version": "1.0.0",
  "description": "Test: Scheduled effects via ticks",
  "orbitals": [
    {
      "name": "SessionManager",
      "entity": {
        "name": "Session",
        "persistence": "runtime",
        "fields": [
          { "name": "id", "type": "string", "required": true },
          { "name": "lastActivity", "type": "timestamp" },
          { "name": "isExpired", "type": "boolean", "default": false },
          { "name": "idleSeconds", "type": "number", "default": 0 }
        ]
      },
      "traits": [
        {
          "name": "SessionTimeout",
          "linkedEntity": "Session",
          "category": "interaction",
          "emits": [
            {
              "event": "TICK",
              "scope": "internal",
              "description": "Internal tick event for session timeout checking"
            }
          ],
          "stateMachine": {
            "states": [
              { "name": "active", "isInitial": true },
              { "name": "idle" },
              { "name": "expired" }
            ],
            "events": [
              { "key": "ACTIVITY", "name": "User Activity" },
              { "key": "TICK", "name": "Tick" },
              { "key": "EXPIRE", "name": "Expire Session" }
            ],
            "transitions": [
              {
                "from": "active",
                "event": "ACTIVITY",
                "to": "active",
                "effects": [
                  ["set", "@entity.lastActivity", "@now"],
                  ["set", "@entity.idleSeconds", 0]
                ]
              },
              {
                "from": "active",
                "event": "TICK",
                "to": "idle",
                "guard": [">", "@entity.idleSeconds", 300],
                "effects": [
                  ["increment", "@entity.idleSeconds", 1]
                ]
              },
              {
                "from": "active",
                "event": "TICK",
                "to": "active",
                "effects": [
                  ["increment", "@entity.idleSeconds", 1]
                ]
              },
              {
                "from": "idle",
                "event": "ACTIVITY",
                "to": "active",
                "effects": [
                  ["set", "@entity.lastActivity", "@now"],
                  ["set", "@entity.idleSeconds", 0]
                ]
              },
              {
                "from": "idle",
                "event": "EXPIRE",
                "to": "expired",
                "effects": [
                  ["set", "@entity.isExpired", true]
                ]
              }
            ]
          },
          "ticks": [
            {
              "name": "idleCheck",
              "interval": 1000,
              "effects": [
                ["emit", "TICK", {}]
              ]
            }
          ]
        }
      ],
      "pages": [
        {
          "name": "SessionPage",
          "path": "/session",
          "traits": [
            { "ref": "SessionTimeout", "linkedEntity": "Session" }
          ]
        }
      ]
    }
  ]
}
