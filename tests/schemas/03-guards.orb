{
  "name": "guards-test",
  "version": "1.0.0",
  "description": "Test: Guard conditions on transitions",
  "orbitals": [
    {
      "name": "AccountManager",
      "entity": {
        "name": "Account",
        "persistence": "persistent",
        "collection": "accounts",
        "fields": [
          { "name": "id", "type": "string", "required": true },
          { "name": "balance", "type": "number", "default": 0 },
          { "name": "isVerified", "type": "boolean", "default": false }
        ]
      },
      "traits": [
        {
          "name": "AccountActions",
          "linkedEntity": "Account",
          "category": "interaction",
          "stateMachine": {
            "states": [
              { "name": "active", "isInitial": true },
              { "name": "frozen" }
            ],
            "events": [
              { "key": "INIT", "name": "Initialize" },
              { "key": "WITHDRAW", "name": "Withdraw Funds", "payload": [
                { "name": "amount", "type": "number", "required": true }
              ]},
              { "key": "FREEZE", "name": "Freeze Account" },
              { "key": "UNFREEZE", "name": "Unfreeze Account" }
            ],
            "transitions": [
              {
                "from": "active",
                "event": "INIT",
                "to": "active",
                "effects": [
                  ["fetch", "Account"],
                  ["render-ui", "main", {
                    "type": "entity-table",
                    "entity": "Account",
                    "columns": ["balance", "isVerified"],
                    "itemActions": [
                      { "event": "WITHDRAW", "label": "Withdraw" },
                      { "event": "FREEZE", "label": "Freeze" }
                    ]
                  }]
                ]
              },
              {
                "from": "active",
                "event": "WITHDRAW",
                "to": "active",
                "guard": ["and",
                  [">=", "@entity.balance", "@payload.amount"],
                  ["=", "@entity.isVerified", true]
                ],
                "effects": [
                  ["set", "@entity.balance", ["-", "@entity.balance", "@payload.amount"]]
                ]
              },
              {
                "from": "active",
                "event": "FREEZE",
                "to": "frozen"
              },
              {
                "from": "frozen",
                "event": "UNFREEZE",
                "to": "active"
              }
            ]
          }
        }
      ],
      "pages": [
        {
          "name": "AccountListPage",
          "path": "/accounts",
          "traits": [
            { "ref": "AccountActions", "linkedEntity": "Account" }
          ]
        }
      ]
    }
  ]
}
