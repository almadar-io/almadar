name: Language Tests

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

jobs:
  language-tests:
    name: Language Tests
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        shell: [typescript, python]

    steps:
      - uses: actions/checkout@v4

      - name: Setup almadar CLI
        run: |
          chmod +x cli/dist/linux-x64/almadar
          echo "${{ github.workspace }}/cli/dist/linux-x64" >> $GITHUB_PATH

      - name: Verify almadar CLI
        run: almadar --version
        shell: bash

      - name: Run language tests
        run: |
          chmod +x tests/run-tests.sh
          ./tests/run-tests.sh --shell ${{ matrix.shell }} --verbose

  validate-schemas:
    name: Validate Test Schemas
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Check JSON validity
        run: |
          echo "Checking test schema JSON validity..."
          for file in tests/schemas/*.orb; do
            echo "  $file"
            python3 -c "import json; json.load(open('$file'))" || exit 1
          done
          echo "All schemas are valid JSON!"

  schema-count:
    name: Schema Coverage
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Count test schemas
        run: |
          count=$(ls tests/schemas/*.orb 2>/dev/null | wc -l)
          echo "Total test schemas: $count"

          # List all schemas
          echo ""
          echo "Test schemas:"
          for file in tests/schemas/*.orb; do
            name=$(basename "$file")
            desc=$(python3 -c "import json; print(json.load(open('$file')).get('description', 'No description'))")
            echo "  - $name: $desc"
          done
