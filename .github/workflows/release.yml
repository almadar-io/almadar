name: Release

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:
    inputs:
      version:
        description: "Version to release (e.g., v1.0.0)"
        required: true
        type: string

env:
  CARGO_TERM_COLOR: always

jobs:
  build:
    name: Build ${{ matrix.target }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - target: x86_64-unknown-linux-gnu
            os: ubuntu-latest
            name: linux-x64
            ext: ""
          - target: aarch64-unknown-linux-gnu
            os: ubuntu-latest
            name: linux-arm64
            ext: ""
            cross: true
          - target: x86_64-apple-darwin
            os: macos-latest
            name: darwin-x64
            ext: ""
          - target: aarch64-apple-darwin
            os: macos-latest
            name: darwin-arm64
            ext: ""
          - target: x86_64-pc-windows-msvc
            os: windows-latest
            name: windows-x64
            ext: ".exe"

    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-action@stable
        with:
          targets: ${{ matrix.target }}

      - name: Install cross-compilation tools
        if: matrix.cross
        run: |
          sudo apt-get update
          sudo apt-get install -y gcc-aarch64-linux-gnu

      - name: Build binary
        run: |
          if [ "${{ matrix.cross }}" = "true" ]; then
            cargo install cross --git https://github.com/cross-rs/cross
            cross build --release --package almadar-cli --target ${{ matrix.target }}
          else
            cargo build --release --package almadar-cli --target ${{ matrix.target }}
          fi
        shell: bash
        working-directory: almadar-rust

      - name: Prepare artifact (Unix)
        if: matrix.os != 'windows-latest'
        run: |
          mkdir -p dist
          cp almadar-rust/target/${{ matrix.target }}/release/almadar dist/almadar
          chmod +x dist/almadar
          cd dist
          tar -czvf almadar-${{ matrix.name }}.tar.gz almadar
          rm almadar

      - name: Prepare artifact (Windows)
        if: matrix.os == 'windows-latest'
        run: |
          mkdir dist
          copy almadar-rust\target\${{ matrix.target }}\release\orbital.exe dist\almadar.exe
          cd dist
          7z a almadar-${{ matrix.name }}.zip almadar.exe
          del almadar.exe
        shell: cmd

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: almadar-${{ matrix.name }}
          path: dist/almadar-${{ matrix.name }}.*

  release:
    name: Create Release
    needs: build
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4

      - name: Get version
        id: version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "version=${{ inputs.version }}" >> $GITHUB_OUTPUT
          else
            echo "version=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
          fi

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Prepare release assets
        run: |
          mkdir -p release
          find artifacts -type f \( -name "*.tar.gz" -o -name "*.zip" \) -exec cp {} release/ \;
          ls -la release/

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.version.outputs.version }}
          name: Almadar ${{ steps.version.outputs.version }}
          draft: false
          prerelease: false
          generate_release_notes: true
          files: release/*
          body: |
            ## Almadar ${{ steps.version.outputs.version }}

            ### Installation

            #### npm (recommended)
            ```bash
            npm install -g @almadar/cli
            ```

            #### Homebrew (macOS/Linux)
            ```bash
            brew install almadar-io/tap/almadar
            ```

            #### Direct Download
            Download the appropriate binary for your platform from the assets below.

            | Platform | Architecture | File |
            |----------|-------------|------|
            | Linux | x64 | `almadar-linux-x64.tar.gz` |
            | Linux | ARM64 | `almadar-linux-arm64.tar.gz` |
            | macOS | Intel | `almadar-darwin-x64.tar.gz` |
            | macOS | Apple Silicon | `almadar-darwin-arm64.tar.gz` |
            | Windows | x64 | `almadar-windows-x64.zip` |

            #### Install Script (Unix)
            ```bash
            curl -fsSL https://almadar.io/install.sh | sh
            ```

            ### Documentation

            - [Getting Started](https://almadar.io/docs/en/getting-started)
            - [CLI Reference](https://almadar.io/docs/en/reference/cli)
            - [Schema Format](https://almadar.io/docs/en/reference/schema)

  publish-npm:
    name: Publish to npm
    needs: release
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: "20"
          registry-url: "https://registry.npmjs.org"

      - name: Get version
        id: version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            VERSION="${{ inputs.version }}"
          else
            VERSION="${GITHUB_REF#refs/tags/}"
          fi
          # Remove 'v' prefix for npm version
          echo "version=${VERSION#v}" >> $GITHUB_OUTPUT

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Prepare npm packages
        run: |
          VERSION=${{ steps.version.outputs.version }}

          # Platform packages
          declare -A PLATFORMS=(
            ["linux-x64"]="linux x64"
            ["linux-arm64"]="linux arm64"
            ["darwin-x64"]="darwin x64"
            ["darwin-arm64"]="darwin arm64"
            ["windows-x64"]="win32 x64"
          )

          for platform in "${!PLATFORMS[@]}"; do
            read os cpu <<< "${PLATFORMS[$platform]}"

            mkdir -p "npm-packages/@almadar/cli-${platform}"
            cd "npm-packages/@almadar/cli-${platform}"

            # Extract binary
            if [[ "$platform" == windows* ]]; then
              unzip "../../../artifacts/almadar-${platform}/almadar-${platform}.zip"
              EXT=".exe"
            else
              tar -xzf "../../../artifacts/almadar-${platform}/almadar-${platform}.tar.gz"
              EXT=""
            fi

            # Create package.json
            cat > package.json << EOF
          {
            "name": "@almadar/cli-${platform}",
            "version": "${VERSION}",
            "description": "Almadar CLI binary for ${platform}",
            "license": "MIT",
            "repository": {
              "type": "git",
              "url": "https://github.com/almadar-io/almadar.git"
            },
            "os": ["${os}"],
            "cpu": ["${cpu}"]
          }
          EOF

            cd ../..
          done

          # Main package
          mkdir -p "@almadar/cli"
          cp -r cli/npm/* "@almadar/cli/"
          cd "@almadar/cli"

          # Update version in package.json
          jq --arg v "$VERSION" '.version = $v | .optionalDependencies |= with_entries(.value = $v)' package.json > tmp.json
          mv tmp.json package.json

          cd ../..

      - name: Publish platform packages
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
        run: |
          for dir in npm-packages/@almadar/cli-*; do
            cd "$dir"
            npm publish --access public || true
            cd -
          done

      - name: Publish main package
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
        run: |
          cd npm-packages/@almadar/cli
          npm publish --access public

  update-homebrew:
    name: Update Homebrew Tap
    needs: release
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Get version
        id: version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "version=${{ inputs.version }}" >> $GITHUB_OUTPUT
          else
            echo "version=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
          fi

      - name: Download release assets and compute SHA256
        id: sha
        run: |
          VERSION=${{ steps.version.outputs.version }}
          BASE_URL="https://github.com/almadar-io/almadar/releases/download/${VERSION}"

          # Download and compute SHA256 for each platform
          for platform in darwin-x64 darwin-arm64 linux-x64 linux-arm64; do
            curl -fsSL "${BASE_URL}/almadar-${platform}.tar.gz" -o "almadar-${platform}.tar.gz"
            SHA=$(sha256sum "almadar-${platform}.tar.gz" | cut -d' ' -f1)
            echo "${platform}=${SHA}" >> $GITHUB_OUTPUT
            echo "SHA256 for ${platform}: ${SHA}"
          done

      - name: Clone Homebrew tap
        run: |
          git clone https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/almadar-io/homebrew-tap.git tap

      - name: Update formula
        run: |
          VERSION=${{ steps.version.outputs.version }}
          VERSION_NUM=${VERSION#v}  # Remove 'v' prefix

          cat > tap/Formula/almadar.rb << 'EOF'
          # Homebrew formula for Almadar CLI
          # Auto-generated by release workflow

          class Almadar < Formula
            desc "Compile Almadar schemas to full-stack applications"
            homepage "https://almadar.io"
            version "VERSION_PLACEHOLDER"
            license "MIT"

            on_macos do
              on_intel do
                url "https://github.com/almadar-io/almadar/releases/download/vVERSION_PLACEHOLDER/almadar-darwin-x64.tar.gz"
                sha256 "SHA_DARWIN_X64"
              end
              on_arm do
                url "https://github.com/almadar-io/almadar/releases/download/vVERSION_PLACEHOLDER/almadar-darwin-arm64.tar.gz"
                sha256 "SHA_DARWIN_ARM64"
              end
            end

            on_linux do
              on_intel do
                url "https://github.com/almadar-io/almadar/releases/download/vVERSION_PLACEHOLDER/almadar-linux-x64.tar.gz"
                sha256 "SHA_LINUX_X64"
              end
              on_arm do
                url "https://github.com/almadar-io/almadar/releases/download/vVERSION_PLACEHOLDER/almadar-linux-arm64.tar.gz"
                sha256 "SHA_LINUX_ARM64"
              end
            end

            def install
              bin.install "almadar"
            end

            test do
              assert_match "Almadar schema compiler", shell_output("#{bin}/almadar --help")
            end
          end
          EOF

          # Replace placeholders
          sed -i "s/VERSION_PLACEHOLDER/${VERSION_NUM}/g" tap/Formula/almadar.rb
          sed -i "s/SHA_DARWIN_X64/${{ steps.sha.outputs.darwin-x64 }}/g" tap/Formula/almadar.rb
          sed -i "s/SHA_DARWIN_ARM64/${{ steps.sha.outputs.darwin-arm64 }}/g" tap/Formula/almadar.rb
          sed -i "s/SHA_LINUX_X64/${{ steps.sha.outputs.linux-x64 }}/g" tap/Formula/almadar.rb
          sed -i "s/SHA_LINUX_ARM64/${{ steps.sha.outputs.linux-arm64 }}/g" tap/Formula/almadar.rb

          cat tap/Formula/almadar.rb

      - name: Commit and push
        run: |
          cd tap
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add Formula/almadar.rb
          git commit -m "Update almadar to ${{ steps.version.outputs.version }}"
          git push
